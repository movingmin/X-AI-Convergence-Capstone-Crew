# -*- coding: utf-8 -*-
# pip install openai python-dotenv requests pydantic

import os, time, requests, json, re, sys
from typing import Optional
from dotenv import load_dotenv
from openai import OpenAI

# -----------------------
# 환경 변수 로드 (.env 권장)
# -----------------------
load_dotenv()

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
if not OPENAI_API_KEY:
    print("[ERR] OPENAI_API_KEY 가 없습니다. .env 또는 환경변수에 설정하세요.")
    sys.exit(1)

client = OpenAI(api_key=OPENAI_API_KEY)

# KIS / MCP 엔드포인트: 모의/실전/MCP 중 선택해서 넣으세요
# 예) MCP: https://openapi.mcp.koreainvestment.com
#     실전: https://openapi.koreainvestment.com:9443
#     모의: https://openapivts.koreainvestment.com:29443
KIS_BASE     = os.getenv("KIS_BASE", "https://openapi.mcp.koreainvestment.com")
APP_KEY      = os.getenv("KIS_APP_KEY")
APP_SECRET   = os.getenv("KIS_APP_SECRET")
CANO         = os.getenv("KIS_CANO")              # (선택) 계좌번호
ACNT_PRDT_CD = os.getenv("KIS_ACNT_PRDT_CD", "01")

for k, v in {"KIS_BASE": KIS_BASE, "KIS_APP_KEY": APP_KEY, "KIS_APP_SECRET": APP_SECRET}.items():
    if not v:
        print(f"[ERR] {k} 가 없습니다. .env 또는 환경변수에 설정하세요.")
        sys.exit(1)

# -----------------------
# 토큰 캐시 & 헬퍼
# -----------------------
_token_cache = {"value": None, "exp": 0}

def kis_get_token() -> str:
    """KIS 토큰 (자동 캐시/갱신)"""
    now = time.time()
    if _token_cache["value"] and now < _token_cache["exp"] - 30:
        return _token_cache["value"]
    url = f"{KIS_BASE}/oauth2/tokenP"  # 문서 기준 확인
    try:
        r = requests.post(
            url,
            json={"appkey": APP_KEY, "appsecret": APP_SECRET},
            headers={"content-type": "application/json"},
            timeout=10,
        )
        r.raise_for_status()
        j = r.json()
        access_token = j.get("access_token") or j.get("accessToken")
        expires_in = int(j.get("expires_in", 3600))
        if not access_token:
            raise RuntimeError(f"토큰 응답에 access_token 이 없습니다: {j}")
        _token_cache["value"] = access_token
        _token_cache["exp"] = now + expires_in
        return access_token
    except requests.HTTPError as e:
        print("[ERR] 토큰 발급 실패:", e, getattr(e, "response", None) and e.response.text)
        raise

def kis_headers(tr_id: str) -> dict:
    """KIS 공통 헤더 구성"""
    return {
        "authorization": f"Bearer {kis_get_token()}",
        "appkey": APP_KEY,
        "appsecret": APP_SECRET,
        "tr_id": tr_id,  # ★ 반드시 문서의 TR ID 로 교체
        "content-type": "application/json; charset=utf-8",
    }

# -----------------------
# KIS(MCP) 호출 함수들
# -----------------------
def mcp_search_info_by_name(query: str) -> Optional[str]:
    """
    종목명으로 6자리 종목코드를 조회 (상품기본조회)
    ※ 엔드포인트/파라미터/TR ID는 KIS 문서
