# open-trading-api + 외부 LLM 활용 가이드 (완전 초보용)

## 1. 사전 준비
- **계정 생성**: 한국투자증권 Open API(모의투자) 계정과 OpenAI API(또는 사용할 LLM 서비스) 계정이 모두 필요합니다. 두 플랫폼에서 발급받은 API 키는 `.env` 또는 `kis_devlp.yaml`에 저장하고 Git에 올리지 않습니다.
- **로컬 환경**: Python 3.13, `uv`(또는 pip) 준비, `open-trading-api/` 리포지토리를 클론해 예제 실행이 가능한지 확인합니다.
- **보안 점검**: 방화벽/IPS가 있는 환경에서 테스트하며, API 호출 로그에 개인식별 정보가 남지 않는지 확인합니다.

## 2. open-trading-api로 데이터 가져오기
1. `open-trading-api/README.md` 절차에 따라 가상계좌 발급 → 토큰 발급 스크립트 실행.
2. 샘플 `rest/auth`/`rest/stock` API 실행해 시세, 체결, 주문 데이터가 정상 반환되는지 확인합니다.
3. 반복 실행이 필요하면 Celery 워커 또는 간단한 `cron`으로 주기적 데이터 수집 스크립트를 등록합니다(예: 5분마다 시세 캡처).
4. 수집된 JSON/CSV는 MySQL 테이블이나 MinIO 버킷에 저장해 나중에 LLM 요약에 활용합니다.

## 3. 외부 LLM과 연동해 요약·분석하기
1. OpenAI Python SDK(`openai` 패키지) 등을 설치하고, `.env`에 `OPENAI_API_KEY`를 넣습니다.
2. Django 혹은 별도 스크립트에서 데이터베이스/파일에서 최신 데이터를 읽고, LLM 프롬프트를 구성합니다. 민감 정보는 익명화하거나 요약해서 전송합니다.
3. LLM 호출은 Celery 비동기 작업으로 처리해 응답 대기 중에도 웹 요청이 막히지 않도록 합니다. 실패 시 재시도 정책을 설정합니다.
4. 받은 응답은 MySQL 테이블(예: `analysis_reports`)이나 MinIO 객체로 저장하고, UI에서 확인할 수 있도록 API를 노출합니다.

## 4. 결과 검증과 재사용
- **로그**: 입력 프롬프트, LLM 응답, 사용량(토큰)을 모두 저장해 나중에 감사할 수 있게 합니다.
- **프롬프트 개선**: 원하는 답이 나오지 않으면, 예시 결과를 프롬프트에 추가하거나, 필요한 지표 리스트(매수/매도 가격, 거래량, 위협 이벤트 요약 등)를 명시합니다.
- **자동화**: 자주 쓰는 주제(예: 특정 종목 위험 요약)는 Celery 주기 작업(Celery beat)으로 등록해 하루 한 번 자동 생성하도록 할 수 있습니다.

## 5. 운영 단계 주의 사항
- API 키는 `.env`/`kis_devlp.yaml`로 관리하고, 장기 저장 시 Secret Manager 또는 HashiCorp Vault 등으로 이전을 고려합니다.
- LLM 호출 비용과 사용량을 모니터링하고, 예산 알림을 설정합니다.
- 외부 LLM이 다운되면 대체 응답(캐시된 요약, “잠시 후 다시 시도”)을 반환하는 폴백 로직을 구현합니다.
- 금융 데이터는 시차·정확도가 중요하므로, LLM이 잘못된 정보를 환각(Hallucination)할 수 있음을 주석과 UI에 명시하고, 사람이 검증하는 절차를 둡니다.
